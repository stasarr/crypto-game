<%- include('./partials/header') %>
<%- include('./partials/progressbar') %>

<div class="container mt-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3 game-bg">
    <h4>Seviye <%= level.number %></h4>
    <span id="thisGameScore"><stroke>Seviye Puanı:</stroke> 100</span>
    <span><stroke>Genel Puan:</stroke> <%= user.score %></span>
    <a href="/logout" class="btn btn-danger btn-sm">Çıkış</a>
  </div>

  <div class="game-alert-info">
    <strong>İpucu Harfler:</strong>
    <% clueLetters.forEach(clue => { %>
      <span class="badge bg-primary me-2">
        <%= clue.encrypted.toLocaleUpperCase('tr-TR') %> ➜ <%= clue.original.toLocaleUpperCase('tr-TR') %>
      </span>
    <% }) %>    
  </div>

  <div class="game-board mb-3">
    <% 
      const encrypted = level.encryptedText;
      const original = level.originalText.replace(/[^a-zA-ZğüşıöçĞÜŞİÖÇ]/g, '');
      const words = encrypted.split(/(\s+)/); // boşluklara göre böl ama boşlukları da koru
      let realIndex = 0;
    
      for (let word of words) {
        const isSpace = /^\s+$/.test(word);
        if (isSpace) {
    %>
          <span class="space"><%= word %></span>
    <%
        } else {
    %>
          <div class="word">
            <% for (let i = 0; i < word.length; i++) {
                 const char = word[i];
                 const isLetter = /[a-zA-ZğüşıöçĞÜŞİÖÇ]/.test(char);
                 if (isLetter) {
                   const originalChar = original[realIndex];
            %>
                <input maxlength="1" 
                       data-index="<%= realIndex %>" 
                       data-answer="<%= originalChar.toLowerCase() %>" 
                       placeholder="<%= char %>" 
                       class="letter-input" autocapitalize="off" autocomplete="off" autocorrect="off"/>
            <%
                   realIndex++;
                 } else {
            %>
                <span class="punctuation"><%= char %></span>
            <% 
                 }
               }
            %>
          </div>
    <%
        }
      }
    %>
  </div>

  <script>
    const originalLetters = <%- JSON.stringify(originalLetters) %>;
    const clueLetters = <%- JSON.stringify(clueLetters) %>;
    const totalScore = <%= user.score %>
  </script>

  <div class="d-flex">
    <div class="mb-3">
      <button id="jokerButton" class="btn btn-warning" style="margin-right: 5px;">Joker Kullan (<span id="jokerCount">3</span>)</button>
    </div>
    <div>
      <button id="submitButton" class="btn btn-success">Cevabı Gönder</button>
    </div>
  </div>

  <hr>

  <h5>Bilgiler</h5>
  <ul class="list-group">
    <li class="list-group-item bg-dark text-lgray">
      <span>Yanlış girdiğiniz her harf için <strong>10 puan</strong> kaybedersiniz.</span>
    </li>
    <li class="list-group-item bg-dark text-lgray">
      <span>Joker kullanmak için <strong>25 puan</strong> harcadığınızı unutmayın.</span>
    </li>
    <li class="list-group-item bg-dark text-lgray">
      <span>Açmak istediğiniz harfi seçtikten sonra joker kullanarak seçtiğiniz harfi açabilirsiniz.</span>
    </li>
  </ul>

  <hr>

  <h5>Liderlik Tablosu</h5>
  <ul class="list-group" id="leaderboard">
    <% if (leaderboard && leaderboard.length > 0) { %>
      <% leaderboard.forEach((user, index) => { %>
        <li class="list-group-item bg-dark text-lgray">
          <strong><%= index + 1 %> - <%= user.username %></strong> - <%= user.score %> Puan
        </li>
      <% }) %>
    <% } else { %>
      <li class="list-group-item bg-dark text-lgray">Liderlik tablosu boş.</li>
    <% } %>
  </ul>

</div>
<div class="modal fade" id="gameLostModal" tabindex="-1" aria-labelledby="gameLostModalLabel" aria-hidden="true" style="background-color: #dc35457a !important;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title w-100" id="gameLostModalLabel">❌ Oyunu Kaybettiniz!</h5>
      </div>
      <div class="modal-body" style="background-color: #2a2e33 !important;">
        Seviye yeniden başlatılıyor. Lütfen bekleyin...
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    const gameBoard = document.querySelector('.game-board');
    const boardWidth = gameBoard.offsetWidth - 3 * parseFloat(getComputedStyle(gameBoard).fontSize);
    
    document.querySelectorAll('.word').forEach(wordEl => {
      
      const inputs = Array.from(wordEl.querySelectorAll('input'));
      if (inputs.length <= 1) return;

      let totalWidth = 0;
      let splitIndex = -1;

      for (let i = 0; i < inputs.length; i++) {
        totalWidth += inputs[i].offsetWidth + 5; // + margin
        if (totalWidth > boardWidth) {
          splitIndex = i;
          break;
        }
      }

      if (splitIndex !== -1) {
        const firstHalf = inputs.slice(0, splitIndex);
        const secondHalf = inputs.slice(splitIndex);

        const hyphen = document.createElement("span");
        hyphen.textContent = "-";
        hyphen.classList.add("punctuation");

        const newWordDiv = document.createElement("div");
        newWordDiv.classList.add("word");

        secondHalf.forEach(input => {
          newWordDiv.appendChild(input);
        });

        // Mevcut word'den ikinci kısmı ayır
        wordEl.innerHTML = "";
        firstHalf.forEach(input => wordEl.appendChild(input));
        wordEl.appendChild(hyphen);

        wordEl.after(newWordDiv);
      }
    });
  });
</script>

<%- include('./partials/footer') %>
